/**
 * EmailMarketingHero Component
 * 
 * A modern, isometric email marketing visualization featuring an animated envelope
 * with a paper plane that emerges, flies in an arc, and returns.
 * 
 * @example
 * // Basic usage
 * <EmailMarketingHero />
 * 
 * // With custom speed
 * <EmailMarketingHero speed={1.5} />
 * 
 * // Paused
 * <EmailMarketingHero isPaused={true} />
 * 
 * // With reduced motion
 * <EmailMarketingHero reducedMotion={true} />
 */

import React, { useMemo } from 'react'
import { motion, Variants, useReducedMotion } from 'framer-motion'

// =============================================================================
// TYPES
// =============================================================================

interface EmailMarketingHeroProps {
  /** Animation speed multiplier (default: 1) */
  speed?: number
  /** Pause the animation */
  isPaused?: boolean
  /** Force reduced motion mode */
  reducedMotion?: boolean
  /** Additional className for the container */
  className?: string
}

// =============================================================================
// ANIMATION CONSTANTS
// =============================================================================

const BASE_DURATION = 9 // Total loop duration in seconds
const PAUSE_DURATION = 1 // Pause between loops

// Timing breakpoints (as percentages of total animation)
const TIMING = {
  flapOpenStart: 0.05,
  flapOpenEnd: 0.15,
  planeEmergeStart: 0.12,
  planeEmergeEnd: 0.25,
  planeFlightPeak: 0.5,
  planeReturnStart: 0.55,
  planeEnterStart: 0.75,
  planeEnterEnd: 0.85,
  flapCloseStart: 0.82,
  flapCloseEnd: 0.92,
  // Remaining time (0.92-1.0) is the pause
}

// =============================================================================
// ANIMATION VARIANTS
// =============================================================================

const createEnvelopeGlowVariants = (duration: number): Variants => ({
  animate: {
    opacity: [0.3, 0.6, 0.3],
    scale: [1, 1.05, 1],
    transition: {
      duration: duration * 0.15,
      repeat: Infinity,
      repeatDelay: duration * 0.85,
      ease: 'easeInOut',
    },
  },
})

const createFlapVariants = (duration: number): Variants => ({
  closed: {
    rotateX: 0,
    originY: 1,
  },
  open: {
    rotateX: -160,
    originY: 1,
    transition: {
      duration: duration * (TIMING.flapOpenEnd - TIMING.flapOpenStart),
      ease: [0.4, 0, 0.2, 1],
    },
  },
})

const createPlaneVariants = (duration: number): Variants => ({
  hidden: {
    x: 0,
    y: 0,
    scale: 0.3,
    opacity: 0,
    rotate: 0,
  },
  flying: {
    x: [0, 30, 120, 180, 200, 160, 80, 20, 0],
    y: [0, -40, -120, -160, -140, -80, -20, 10, 0],
    scale: [0.3, 0.8, 1, 1, 1, 0.9, 0.7, 0.5, 0.3],
    opacity: [0, 1, 1, 1, 1, 1, 1, 0.8, 0],
    rotate: [0, -20, -35, -15, 10, 30, 45, 60, 90],
    transition: {
      duration: duration * (TIMING.planeEnterEnd - TIMING.planeEmergeStart),
      ease: 'easeInOut',
      times: [0, 0.1, 0.3, 0.45, 0.55, 0.7, 0.85, 0.95, 1],
    },
  },
})

const createDecorVariants = (duration: number, delay: number): Variants => ({
  animate: {
    opacity: [0, 0.6, 0.6, 0],
    scale: [0.8, 1, 1, 0.8],
    transition: {
      duration: duration * 0.6,
      delay: delay,
      repeat: Infinity,
      repeatDelay: duration * 0.4,
      ease: 'easeInOut',
    },
  },
})

// =============================================================================
// COMPONENT
// =============================================================================

const EmailMarketingHero: React.FC<EmailMarketingHeroProps> = ({
  speed = 1,
  isPaused = false,
  reducedMotion: forceReducedMotion = false,
  className = '',
}) => {
  // Check for system reduced motion preference
  const systemReducedMotion = useReducedMotion()
  const shouldReduceMotion = forceReducedMotion || systemReducedMotion

  // Calculate actual duration based on speed
  const duration = useMemo(() => (BASE_DURATION + PAUSE_DURATION) / speed, [speed])

  // Create memoized variants
  const envelopeGlowVariants = useMemo(() => createEnvelopeGlowVariants(duration), [duration])
  const flapVariants = useMemo(() => createFlapVariants(duration), [duration])
  const planeVariants = useMemo(() => createPlaneVariants(duration), [duration])

  // Animation state for sequencing
  const [animationPhase, setAnimationPhase] = React.useState<'closed' | 'opening' | 'flying' | 'closing'>('closed')

  // Animation sequence controller
  React.useEffect(() => {
    if (isPaused || shouldReduceMotion) return

    const phases = [
      { phase: 'opening' as const, delay: duration * TIMING.flapOpenStart * 1000 },
      { phase: 'flying' as const, delay: duration * TIMING.planeEmergeStart * 1000 },
      { phase: 'closing' as const, delay: duration * TIMING.flapCloseStart * 1000 },
      { phase: 'closed' as const, delay: duration * 1000 },
    ]

    const timeouts: NodeJS.Timeout[] = []

    const runSequence = () => {
      phases.forEach(({ phase, delay }) => {
        const timeout = setTimeout(() => setAnimationPhase(phase), delay)
        timeouts.push(timeout)
      })
    }

    runSequence()
    const interval = setInterval(runSequence, duration * 1000)

    return () => {
      timeouts.forEach(clearTimeout)
      clearInterval(interval)
    }
  }, [duration, isPaused, shouldReduceMotion])

  // Reduced motion: show static state
  if (shouldReduceMotion) {
    return (
      <div className={`relative w-full max-w-lg ${className}`}>
        <svg viewBox="0 0 400 350" className="w-full h-auto">
          <StaticEnvelope />
        </svg>
      </div>
    )
  }

  return (
    <div className={`relative w-full max-w-lg select-none ${className}`}>
      {/* Ambient background glow */}
      <div className="absolute inset-0 blur-3xl opacity-20 pointer-events-none">
        <div className="absolute top-1/3 left-1/2 -translate-x-1/2 w-48 h-48 bg-blue-500 rounded-full" />
        <div className="absolute bottom-1/4 right-1/3 w-32 h-32 bg-indigo-600 rounded-full" />
      </div>

      <motion.svg
        viewBox="0 0 400 350"
        className="w-full h-auto relative z-10"
        preserveAspectRatio="xMidYMid meet"
        initial="closed"
        animate={isPaused ? 'closed' : 'animate'}
      >
        <defs>
          {/* Envelope body gradient */}
          <linearGradient id="emh-envelopeBody" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#475569" />
            <stop offset="50%" stopColor="#334155" />
            <stop offset="100%" stopColor="#1e293b" />
          </linearGradient>

          {/* Envelope flap gradient */}
          <linearGradient id="emh-envelopeFlap" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#64748b" />
            <stop offset="100%" stopColor="#475569" />
          </linearGradient>

          {/* Envelope inner gradient */}
          <linearGradient id="emh-envelopeInner" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#1e293b" />
            <stop offset="100%" stopColor="#0f172a" />
          </linearGradient>

          {/* Paper plane gradient */}
          <linearGradient id="emh-planeBody" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#f8fafc" />
            <stop offset="50%" stopColor="#e2e8f0" />
            <stop offset="100%" stopColor="#cbd5e1" />
          </linearGradient>

          {/* Plane accent gradient */}
          <linearGradient id="emh-planeAccent" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#3b82f6" />
            <stop offset="100%" stopColor="#6366f1" />
          </linearGradient>

          {/* Glow gradient */}
          <radialGradient id="emh-glow" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.4" />
            <stop offset="100%" stopColor="#3b82f6" stopOpacity="0" />
          </radialGradient>

          {/* Decorative dot gradient */}
          <linearGradient id="emh-decorDot" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#60a5fa" />
            <stop offset="100%" stopColor="#818cf8" />
          </linearGradient>

          {/* Filters */}
          <filter id="emh-softGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="3" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>

          <filter id="emh-shadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="4" stdDeviation="6" floodOpacity="0.3" />
          </filter>

          <filter id="emh-innerShadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="2" stdDeviation="2" floodOpacity="0.2" />
          </filter>
        </defs>

        {/* Decorative elements - floating dots */}
        <DecorativeDots duration={duration} isPaused={isPaused} />

        {/* Envelope glow effect */}
        <motion.ellipse
          cx="200"
          cy="220"
          rx="120"
          ry="60"
          fill="url(#emh-glow)"
          variants={envelopeGlowVariants}
          animate="animate"
          style={{ transformOrigin: '200px 220px' }}
        />

        {/* Main envelope group */}
        <g filter="url(#emh-shadow)">
          {/* Envelope shadow on ground */}
          <ellipse
            cx="200"
            cy="280"
            rx="100"
            ry="20"
            fill="#000"
            opacity="0.15"
          />

          {/* Envelope body - back */}
          <polygon
            points="80,160 200,100 320,160 320,260 80,260"
            fill="url(#emh-envelopeBody)"
          />

          {/* Envelope inner (visible when flap open) */}
          <motion.polygon
            points="85,165 200,110 315,165 315,255 85,255"
            fill="url(#emh-envelopeInner)"
            initial={{ opacity: 0 }}
            animate={{
              opacity: animationPhase === 'opening' || animationPhase === 'flying' ? 1 : 0,
            }}
            transition={{ duration: 0.3 }}
          />

          {/* Envelope body - front flap (bottom) */}
          <polygon
            points="80,180 200,260 320,180 320,260 80,260"
            fill="url(#emh-envelopeBody)"
          />

          {/* Envelope front face highlight */}
          <polygon
            points="85,185 200,255 315,185 315,255 85,255"
            fill="#475569"
            opacity="0.3"
          />

          {/* Envelope edge lines for depth */}
          <line x1="80" y1="160" x2="80" y2="260" stroke="#1e293b" strokeWidth="1" />
          <line x1="320" y1="160" x2="320" y2="260" stroke="#1e293b" strokeWidth="1" />
          <line x1="80" y1="260" x2="320" y2="260" stroke="#1e293b" strokeWidth="1" />

          {/* Envelope flap (top) - animated */}
          <motion.g
            style={{ 
              transformOrigin: '200px 160px',
              perspective: 800,
            }}
            animate={{
              rotateX: animationPhase === 'opening' || animationPhase === 'flying' ? -150 : 0,
            }}
            transition={{
              duration: duration * 0.1,
              ease: [0.4, 0, 0.2, 1],
            }}
          >
            {/* Flap outer */}
            <polygon
              points="80,160 200,100 320,160 200,220"
              fill="url(#emh-envelopeFlap)"
            />
            
            {/* Flap inner (back side, visible when open) */}
            <motion.polygon
              points="85,160 200,105 315,160 200,210"
              fill="#334155"
              initial={{ opacity: 0 }}
              animate={{
                opacity: animationPhase === 'opening' || animationPhase === 'flying' ? 0.8 : 0,
              }}
              transition={{ duration: 0.2 }}
            />

            {/* Flap highlight line */}
            <line
              x1="80"
              y1="160"
              x2="200"
              y2="100"
              stroke="#64748b"
              strokeWidth="1"
              opacity="0.5"
            />
            <line
              x1="200"
              y1="100"
              x2="320"
              y2="160"
              stroke="#64748b"
              strokeWidth="1"
              opacity="0.5"
            />
          </motion.g>

          {/* Seal/wax stamp (decorative) */}
          <motion.g
            animate={{
              opacity: animationPhase === 'closed' || animationPhase === 'closing' ? 1 : 0,
              scale: animationPhase === 'closed' || animationPhase === 'closing' ? 1 : 0.8,
            }}
            transition={{ duration: 0.3 }}
            style={{ transformOrigin: '200px 175px' }}
          >
            <circle cx="200" cy="175" r="15" fill="url(#emh-planeAccent)" />
            <circle cx="200" cy="175" r="10" fill="none" stroke="#fff" strokeWidth="1" opacity="0.3" />
            {/* @ symbol simplified */}
            <circle cx="200" cy="175" r="5" fill="none" stroke="#fff" strokeWidth="1.5" />
            <circle cx="202" cy="175" r="2" fill="#fff" />
          </motion.g>
        </g>

        {/* Paper Plane - animated */}
        <motion.g
          style={{ transformOrigin: '200px 180px' }}
          variants={planeVariants}
          initial="hidden"
          animate={animationPhase === 'flying' ? 'flying' : 'hidden'}
        >
          <PaperPlane />
        </motion.g>

        {/* Plane trail effect */}
        <motion.g
          initial={{ opacity: 0 }}
          animate={{
            opacity: animationPhase === 'flying' ? [0, 0.5, 0] : 0,
          }}
          transition={{
            duration: duration * 0.3,
            delay: duration * 0.05,
            repeat: animationPhase === 'flying' ? 1 : 0,
          }}
        >
          <TrailEffect />
        </motion.g>

        {/* Label */}
        <motion.text
          x="200"
          y="320"
          textAnchor="middle"
          fill="#94a3b8"
          fontSize="13"
          fontWeight="500"
          style={{ fontFamily: 'Outfit, system-ui, sans-serif' }}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.5 }}
        >
          EMAIL MARKETING
        </motion.text>
      </motion.svg>

      {/* Stats panel */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.8 }}
        className="flex justify-center gap-4 md:gap-6 text-center mt-4"
      >
        <StatCard value="98.2%" label="Delivered" gradient="from-blue-400 to-indigo-400" />
        <StatCard value="42.5%" label="Open Rate" gradient="from-indigo-400 to-purple-400" />
        <StatCard value="8.3%" label="Click Rate" gradient="from-purple-400 to-pink-400" />
      </motion.div>
    </div>
  )
}

// =============================================================================
// SUB-COMPONENTS
// =============================================================================

/** Static envelope for reduced motion */
const StaticEnvelope: React.FC = () => (
  <g>
    <polygon
      points="80,160 200,100 320,160 320,260 80,260"
      fill="#334155"
    />
    <polygon
      points="80,180 200,260 320,180 320,260 80,260"
      fill="#475569"
    />
    <polygon
      points="80,160 200,100 320,160 200,220"
      fill="#64748b"
    />
    <circle cx="200" cy="175" r="12" fill="#6366f1" />
  </g>
)

/** Paper plane SVG using simple primitives */
const PaperPlane: React.FC = () => (
  <g filter="url(#emh-softGlow)">
    {/* Main body */}
    <polygon
      points="0,0 50,-15 100,0 50,8"
      fill="url(#emh-planeBody)"
      stroke="#94a3b8"
      strokeWidth="0.5"
    />
    
    {/* Top wing */}
    <polygon
      points="20,-5 50,-30 80,-5"
      fill="url(#emh-planeBody)"
      stroke="#94a3b8"
      strokeWidth="0.5"
    />
    
    {/* Center fold line */}
    <line
      x1="50"
      y1="-25"
      x2="50"
      y2="5"
      stroke="#cbd5e1"
      strokeWidth="1"
    />
    
    {/* Accent stripe */}
    <line
      x1="25"
      y1="0"
      x2="75"
      y2="0"
      stroke="url(#emh-planeAccent)"
      strokeWidth="2"
      strokeLinecap="round"
    />
    
    {/* Highlight */}
    <ellipse
      cx="40"
      cy="-12"
      rx="8"
      ry="5"
      fill="#fff"
      opacity="0.3"
    />
  </g>
)

/** Decorative floating dots */
const DecorativeDots: React.FC<{ duration: number; isPaused: boolean }> = ({ duration, isPaused }) => {
  const dots = [
    { cx: 100, cy: 80, r: 4, delay: 0 },
    { cx: 320, cy: 100, r: 3, delay: 0.5 },
    { cx: 80, cy: 200, r: 3, delay: 1 },
    { cx: 340, cy: 220, r: 4, delay: 1.5 },
    { cx: 150, cy: 60, r: 2, delay: 2 },
    { cx: 280, cy: 280, r: 3, delay: 2.5 },
  ]

  return (
    <g>
      {dots.map((dot, i) => (
        <motion.circle
          key={i}
          cx={dot.cx}
          cy={dot.cy}
          r={dot.r}
          fill="url(#emh-decorDot)"
          initial={{ opacity: 0, scale: 0.5 }}
          animate={isPaused ? {} : {
            opacity: [0, 0.7, 0.7, 0],
            scale: [0.5, 1, 1, 0.5],
          }}
          transition={{
            duration: duration * 0.5,
            delay: dot.delay,
            repeat: Infinity,
            repeatDelay: duration * 0.5,
            ease: 'easeInOut',
          }}
        />
      ))}
      
      {/* Decorative lines */}
      <motion.line
        x1="60"
        y1="120"
        x2="75"
        y2="110"
        stroke="url(#emh-decorDot)"
        strokeWidth="2"
        strokeLinecap="round"
        initial={{ opacity: 0 }}
        animate={isPaused ? {} : { opacity: [0, 0.5, 0] }}
        transition={{
          duration: duration * 0.4,
          delay: 1,
          repeat: Infinity,
          repeatDelay: duration * 0.6,
        }}
      />
      <motion.line
        x1="330"
        y1="170"
        x2="350"
        y2="160"
        stroke="url(#emh-decorDot)"
        strokeWidth="2"
        strokeLinecap="round"
        initial={{ opacity: 0 }}
        animate={isPaused ? {} : { opacity: [0, 0.5, 0] }}
        transition={{
          duration: duration * 0.4,
          delay: 2,
          repeat: Infinity,
          repeatDelay: duration * 0.6,
        }}
      />
    </g>
  )
}

/** Trail effect behind paper plane */
const TrailEffect: React.FC = () => (
  <g>
    <line
      x1="180"
      y1="120"
      x2="140"
      y2="150"
      stroke="#60a5fa"
      strokeWidth="2"
      strokeLinecap="round"
      opacity="0.4"
    />
    <line
      x1="175"
      y1="115"
      x2="145"
      y2="135"
      stroke="#818cf8"
      strokeWidth="1.5"
      strokeLinecap="round"
      opacity="0.3"
    />
    <circle cx="130" cy="160" r="3" fill="#60a5fa" opacity="0.3" />
    <circle cx="120" cy="175" r="2" fill="#818cf8" opacity="0.2" />
  </g>
)

/** Stats card component */
const StatCard: React.FC<{ value: string; label: string; gradient: string }> = ({
  value,
  label,
  gradient,
}) => (
  <div className="bg-slate-800/50 backdrop-blur-sm rounded-lg px-4 py-2 border border-slate-700/50">
    <div className={`text-xl font-bold bg-gradient-to-r ${gradient} bg-clip-text text-transparent`}>
      {value}
    </div>
    <div className="text-xs text-slate-400 uppercase tracking-wider">{label}</div>
  </div>
)

export default EmailMarketingHero

