import React, { useState, useEffect, useCallback } from 'react'
import { motion, AnimatePresence } from 'framer-motion'

interface BidChip {
  id: number
  startX: number
  targetX: number
  delay: number
  isHit: boolean
}

interface ClickEffect {
  id: number
  x: number
}

const SEMBidTarget = () => {
  const [chips, setChips] = useState<BidChip[]>([])
  const [clickEffects, setClickEffects] = useState<ClickEffect[]>([])

  const createChip = useCallback(() => {
    const id = Date.now() + Math.random()
    // Random starting position
    const startX = Math.random() * 200 - 100
    // 30% chance of hitting the target center
    const isHit = Math.random() < 0.3
    // If hit, land near center; otherwise, land randomly outside
    const targetX = isHit 
      ? (Math.random() * 30 - 15) 
      : (Math.random() > 0.5 ? 60 + Math.random() * 40 : -60 - Math.random() * 40)
    const delay = Math.random() * 0.2

    return { id, startX, targetX, delay, isHit }
  }, [])

  useEffect(() => {
    // Initial chips
    const initialChips = Array.from({ length: 3 }, () => createChip())
    setChips(initialChips)

    // Spawn new chips periodically
    const interval = setInterval(() => {
      setChips(prev => {
        const filtered = prev.slice(-8)
        return [...filtered, createChip()]
      })
    }, 800)

    return () => clearInterval(interval)
  }, [createChip])

  const handleChipComplete = (chip: BidChip) => {
    // Remove chip
    setChips(prev => prev.filter(c => c.id !== chip.id))

    // If it was a hit, trigger click effect
    if (chip.isHit) {
      const effectId = Date.now() + Math.random()
      setClickEffects(prev => [...prev.slice(-4), { id: effectId, x: chip.targetX }])

      // Remove effect after animation
      setTimeout(() => {
        setClickEffects(prev => prev.filter(e => e.id !== effectId))
      }, 1500)
    }
  }

  return (
    <div className="relative w-full max-w-md select-none flex flex-col items-center">
      {/* Ambient glow */}
      <div className="absolute inset-0 blur-3xl opacity-20 pointer-events-none">
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/4 w-56 h-56 bg-blue-500 rounded-full" />
        <div className="absolute bottom-1/4 left-1/2 -translate-x-1/2 w-40 h-40 bg-indigo-600 rounded-full" />
      </div>

      <svg
        viewBox="0 0 400 420"
        className="w-full max-h-[60vh] relative z-10"
        preserveAspectRatio="xMidYMid meet"
      >
        <defs>
          {/* Target ring gradients */}
          <linearGradient id="sem-ring1" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#ef4444" stopOpacity="0.9" />
            <stop offset="100%" stopColor="#dc2626" stopOpacity="0.8" />
          </linearGradient>
          
          <linearGradient id="sem-ring2" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#f8fafc" stopOpacity="0.95" />
            <stop offset="100%" stopColor="#e2e8f0" stopOpacity="0.9" />
          </linearGradient>
          
          <linearGradient id="sem-ring3" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#ef4444" stopOpacity="0.9" />
            <stop offset="100%" stopColor="#b91c1c" stopOpacity="0.8" />
          </linearGradient>
          
          <linearGradient id="sem-bullseye" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#fef2f2" stopOpacity="1" />
            <stop offset="100%" stopColor="#fecaca" stopOpacity="0.95" />
          </linearGradient>

          {/* Floor gradient */}
          <linearGradient id="sem-floor" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#1e293b" stopOpacity="0.6" />
            <stop offset="100%" stopColor="#0f172a" stopOpacity="0.4" />
          </linearGradient>

          {/* Chip gradient */}
          <linearGradient id="sem-chipGold" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#fbbf24" />
            <stop offset="50%" stopColor="#f59e0b" />
            <stop offset="100%" stopColor="#d97706" />
          </linearGradient>

          <linearGradient id="sem-chipBlue" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#60a5fa" />
            <stop offset="50%" stopColor="#3b82f6" />
            <stop offset="100%" stopColor="#2563eb" />
          </linearGradient>

          {/* Click effect gradient */}
          <linearGradient id="sem-clickGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#22c55e" />
            <stop offset="100%" stopColor="#16a34a" />
          </linearGradient>

          {/* Glow filters */}
          <filter id="sem-glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="4" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>

          <filter id="sem-softGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="2" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>

          <filter id="sem-shadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="4" stdDeviation="3" floodOpacity="0.3" />
          </filter>
        </defs>

        {/* Floor/Ground plane - isometric */}
        <motion.g
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.8 }}
        >
          <ellipse
            cx="200"
            cy="320"
            rx="180"
            ry="60"
            fill="url(#sem-floor)"
          />
        </motion.g>

        {/* Target/Bullseye - isometric perspective */}
        <motion.g
          initial={{ opacity: 0, scale: 0.8 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{ duration: 0.8, delay: 0.2 }}
        >
          {/* Outer ring - Red */}
          <ellipse
            cx="200"
            cy="280"
            rx="120"
            ry="40"
            fill="url(#sem-ring1)"
            filter="url(#sem-shadow)"
          />
          
          {/* Second ring - White */}
          <ellipse
            cx="200"
            cy="280"
            rx="90"
            ry="30"
            fill="url(#sem-ring2)"
          />
          
          {/* Third ring - Red */}
          <ellipse
            cx="200"
            cy="280"
            rx="60"
            ry="20"
            fill="url(#sem-ring3)"
          />
          
          {/* Center - Bullseye */}
          <ellipse
            cx="200"
            cy="280"
            rx="30"
            ry="10"
            fill="url(#sem-bullseye)"
          />

          {/* Center dot */}
          <ellipse
            cx="200"
            cy="280"
            rx="8"
            ry="3"
            fill="#ef4444"
          />
        </motion.g>

        {/* Falling Bid Chips */}
        <AnimatePresence>
          {chips.map((chip) => (
            <BidChip
              key={chip.id}
              chip={chip}
              onComplete={() => handleChipComplete(chip)}
            />
          ))}
        </AnimatePresence>

        {/* Click Effects */}
        <AnimatePresence>
          {clickEffects.map((effect) => (
            <ClickEffect key={effect.id} x={effect.x} />
          ))}
        </AnimatePresence>

        {/* Label */}
        <motion.g
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 1 }}
        >
          <text
            x="200"
            y="380"
            textAnchor="middle"
            fill="#94a3b8"
            fontSize="14"
            fontWeight="500"
            style={{ fontFamily: 'Outfit, sans-serif' }}
          >
            SEM BID TARGETING
          </text>
        </motion.g>
      </svg>

      {/* Stats */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 1.2 }}
        className="flex justify-center gap-4 md:gap-6 text-center mt-4"
      >
        <div className="bg-slate-800/50 backdrop-blur-sm rounded-lg px-4 py-2 border border-slate-700/50">
          <div className="text-xl font-bold bg-gradient-to-r from-amber-400 to-yellow-500 bg-clip-text text-transparent">
            $2.40
          </div>
          <div className="text-xs text-slate-400 uppercase tracking-wider">Avg CPC</div>
        </div>
        <div className="bg-slate-800/50 backdrop-blur-sm rounded-lg px-4 py-2 border border-slate-700/50">
          <div className="text-xl font-bold bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent">
            4.2%
          </div>
          <div className="text-xs text-slate-400 uppercase tracking-wider">CTR</div>
        </div>
        <div className="bg-slate-800/50 backdrop-blur-sm rounded-lg px-4 py-2 border border-slate-700/50">
          <div className="text-xl font-bold bg-gradient-to-r from-blue-400 to-indigo-500 bg-clip-text text-transparent">
            312%
          </div>
          <div className="text-xs text-slate-400 uppercase tracking-wider">ROAS</div>
        </div>
      </motion.div>
    </div>
  )
}

// Bid Chip Component
const BidChip = ({
  chip,
  onComplete,
}: {
  chip: BidChip
  onComplete: () => void
}) => {
  const { startX, targetX, delay, isHit } = chip
  const isGold = Math.random() > 0.5

  // Calculate landing Y based on distance from center (isometric perspective)
  const distanceFromCenter = Math.abs(targetX)
  const landingY = 280 - (distanceFromCenter * 0.1)

  return (
    <motion.g
      initial={{ 
        x: 200 + startX, 
        y: 30, 
        opacity: 0,
        scale: 0.5,
        rotateX: 0
      }}
      animate={{
        x: 200 + targetX,
        y: landingY,
        opacity: [0, 1, 1, isHit ? 1 : 0],
        scale: [0.5, 1, 1, isHit ? 0.8 : 0.3],
        rotateX: [0, 180, 360, 360]
      }}
      transition={{
        duration: 2,
        delay,
        ease: [0.25, 0.46, 0.45, 0.94], // easeOutQuad for natural fall
        times: [0, 0.3, 0.7, 1]
      }}
      onAnimationComplete={onComplete}
    >
      {/* Chip shadow */}
      <motion.ellipse
        cx={0}
        cy={15}
        rx={12}
        ry={4}
        fill="#000"
        opacity={0.2}
        animate={{
          opacity: [0, 0.3, 0.2],
          ry: [2, 4, 3]
        }}
        transition={{
          duration: 2,
          delay,
          times: [0, 0.7, 1]
        }}
      />

      {/* Main chip body */}
      <ellipse
        cx={0}
        cy={0}
        rx={14}
        ry={14}
        fill={isGold ? 'url(#sem-chipGold)' : 'url(#sem-chipBlue)'}
        filter="url(#sem-softGlow)"
      />

      {/* Chip edge (3D effect) */}
      <ellipse
        cx={0}
        cy={2}
        rx={14}
        ry={14}
        fill={isGold ? '#b45309' : '#1d4ed8'}
        opacity={0.5}
      />

      {/* Chip inner circle */}
      <ellipse
        cx={0}
        cy={0}
        rx={10}
        ry={10}
        fill="none"
        stroke={isGold ? '#fef3c7' : '#bfdbfe'}
        strokeWidth={1.5}
        opacity={0.6}
      />

      {/* Dollar/Bid symbol */}
      <text
        x={0}
        y={5}
        textAnchor="middle"
        fill={isGold ? '#fef3c7' : '#e0f2fe'}
        fontSize="12"
        fontWeight="bold"
        style={{ fontFamily: 'Outfit, sans-serif' }}
      >
        $
      </text>
    </motion.g>
  )
}

// Click Effect Component (checkmark animation)
const ClickEffect = ({ x }: { x: number }) => {
  return (
    <motion.g
      initial={{ x: 200 + x, y: 280 }}
    >
      {/* Expanding ring */}
      <motion.ellipse
        cx={0}
        cy={0}
        rx={20}
        ry={7}
        fill="none"
        stroke="#22c55e"
        strokeWidth={3}
        initial={{ scale: 0.5, opacity: 1 }}
        animate={{ 
          scale: [0.5, 2.5],
          opacity: [1, 0],
          ry: [7, 20]
        }}
        transition={{ duration: 0.8, ease: 'easeOut' }}
      />

      {/* Second ring */}
      <motion.ellipse
        cx={0}
        cy={0}
        rx={20}
        ry={7}
        fill="none"
        stroke="#4ade80"
        strokeWidth={2}
        initial={{ scale: 0.3, opacity: 1 }}
        animate={{ 
          scale: [0.3, 2],
          opacity: [1, 0],
          ry: [7, 18]
        }}
        transition={{ duration: 0.6, delay: 0.1, ease: 'easeOut' }}
      />

      {/* CLICK text popup */}
      <motion.g
        initial={{ y: 0, opacity: 0, scale: 0 }}
        animate={{ 
          y: -60,
          opacity: [0, 1, 1, 0],
          scale: [0.5, 1.2, 1, 0.8]
        }}
        transition={{ duration: 1.2, ease: 'easeOut' }}
      >
        {/* Background pill */}
        <rect
          x={-28}
          y={-14}
          width={56}
          height={28}
          rx={14}
          fill="#22c55e"
          filter="url(#sem-glow)"
        />
        
        {/* CLICK text */}
        <text
          x={0}
          y={5}
          textAnchor="middle"
          fill="white"
          fontSize="11"
          fontWeight="bold"
          style={{ fontFamily: 'Outfit, sans-serif' }}
        >
          CLICK!
        </text>
      </motion.g>

      {/* Checkmark */}
      <motion.g
        initial={{ scale: 0, opacity: 0 }}
        animate={{ 
          scale: [0, 1.3, 1],
          opacity: [0, 1, 0]
        }}
        transition={{ duration: 1, delay: 0.3, ease: 'easeOut' }}
      >
        <circle
          cx={0}
          cy={-30}
          r={12}
          fill="url(#sem-clickGradient)"
        />
        {/* Checkmark path using lines */}
        <line
          x1={-5}
          y1={-30}
          x2={-1}
          y2={-26}
          stroke="white"
          strokeWidth={2.5}
          strokeLinecap="round"
        />
        <line
          x1={-1}
          y1={-26}
          x2={6}
          y2={-35}
          stroke="white"
          strokeWidth={2.5}
          strokeLinecap="round"
        />
      </motion.g>
    </motion.g>
  )
}

export default SEMBidTarget

